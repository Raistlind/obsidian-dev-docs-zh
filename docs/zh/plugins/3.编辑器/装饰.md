
---
è£…é¥°å¯ä»¥è®©ä½ æ§åˆ¶[[ç¼–è¾‘å™¨æ‰©å±•]]ä¸­å†…å®¹çš„ç»˜åˆ¶æˆ–æ ·å¼ã€‚å¦‚æœä½ æƒ³é€šè¿‡æ·»åŠ ã€æ›¿æ¢ç¼–è¾‘å™¨ä¸­çš„å…ƒç´ æˆ–ä¸ºå…¶è®¾è®¡æ ·å¼æ¥æ”¹å˜ç¼–è¾‘å™¨çš„å¤–è§‚å’Œè§‚æ„Ÿï¼Œé‚£ä¹ˆä½ å¾ˆå¯èƒ½éœ€è¦ä½¿ç”¨è£…é¥°ã€‚

åœ¨æœ¬èŠ‚ç»“æŸæ—¶ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- äº†è§£å¦‚ä½•ä½¿ç”¨è£…é¥°æ¥æ”¹å˜ç¼–è¾‘å™¨å¤–è§‚ã€‚
- äº†è§£ä½¿ç”¨çŠ¶æ€å­—æ®µå’Œè§†å›¾æ’ä»¶æä¾›è£…é¥°çš„åŒºåˆ«ã€‚


> [!NOTE]
> 
> æœ¬é¡µæ—¨åœ¨ä¸ºObsidian æ’ä»¶å¼€å‘äººå‘˜æç‚¼ CodeMirror 6 å®˜æ–¹æ–‡æ¡£ã€‚æœ‰å…³çŠ¶æ€å­—æ®µçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…Â [Decorating the Document](https://codemirror.net/docs/guide/#decorating-the-document) ã€‚

## å…ˆå†³æ¡ä»¶

- å¯¹[[çŠ¶æ€å­—æ®µ]]æœ‰åŸºæœ¬äº†è§£ã€‚
- å¯¹[[è§†å›¾æ’ä»¶]]æœ‰åŸºæœ¬äº†è§£ã€‚

## æ¦‚è¿°

å¦‚æœæ²¡æœ‰è£…é¥°ï¼Œæ–‡æ¡£å°†æ˜¾ç¤ºä¸ºçº¯æ–‡æœ¬ï¼Œè¿™æœ‰äº›æ²¡è¶£ã€‚ä½¿ç”¨è£…é¥°ï¼Œä½ å¯ä»¥æ”¹å˜æ–‡æ¡£çš„æ˜¾ç¤ºæ–¹å¼ï¼Œä¾‹å¦‚é€šè¿‡é«˜äº®æ˜¾ç¤ºæ–‡æœ¬æˆ–æ·»åŠ è‡ªå®šä¹‰ HTML å…ƒç´ ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç±»å‹çš„è£…é¥°ï¼š

- ä½¿ç”¨[Mark decorations](https://codemirror.net/docs/ref/#view.Decoration%5Emark)Â æ”¹å˜ç°æœ‰å…ƒç´ æ ·å¼ã€‚
- ä½¿ç”¨[Widget decorations](https://codemirror.net/docs/ref/#view.Decoration%5Ewidget)Â åœ¨æ–‡æ¡£ä¸­æ’å…¥å°éƒ¨ä»¶å…ƒç´ ã€‚
- ä½¿ç”¨[Replace decorations](https://codemirror.net/docs/ref/#view.Decoration%5Ereplace)Â éšè—å¯ä½¿ç”¨å…¶å®ƒå…ƒç´ æ›¿æ¢æ–‡æ¡£çš„éƒ¨åˆ†å†…å®¹ã€‚
- ä½¿ç”¨[Line decorations](https://codemirror.net/docs/ref/#view.Decoration%5Eline)Â ä¸ºçº¿æ¡æ·»åŠ æ ·å¼ã€‚

è¦ä½¿ç”¨è£…é¥°ï¼Œéœ€è¦åœ¨ç¼–è¾‘å™¨æ‰©å±•ä¸­åˆ›å»ºè£…é¥°ï¼Œå¹¶ç”±æ‰©å±•å°†å…¶æä¾›ç»™ç¼–è¾‘å™¨ã€‚å‘ç¼–è¾‘å™¨æä¾›è£…é¥°æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨[[çŠ¶æ€å­—æ®µ]]ï¼Œå¦ä¸€ç§æ˜¯é—´æ¥ä½¿ç”¨[[è§†å›¾æ’ä»¶]]ã€‚

## åº”è¯¥ä½¿ç”¨è§†å›¾æ’ä»¶è¿˜æ˜¯çŠ¶æ€å­—æ®µï¼Ÿ

è§†å›¾æ’ä»¶å’ŒçŠ¶æ€å­—æ®µéƒ½å¯ä»¥ä¸ºç¼–è¾‘å™¨æä¾›è£…é¥°ï¼Œä½†ä¸¤è€…æœ‰ä¸€äº›åŒºåˆ«ã€‚

- å¦‚æœå¯ä»¥æ ¹æ®[[è§†çª—]]ä¸­çš„å†…å®¹ç¡®å®šè£…é¥°ï¼Œåˆ™ä½¿ç”¨è§†å›¾æ’ä»¶ã€‚
- å¦‚æœéœ€è¦ç®¡ç†è§†çª—ä»¥å¤–çš„è£…é¥°ï¼Œè¯·ä½¿ç”¨çŠ¶æ€å­—æ®µã€‚
- å¦‚æœè¦æ›´æ”¹è§†çª—çš„å†…å®¹ï¼Œä¾‹å¦‚æ·»åŠ æ¢è¡Œç¬¦ï¼Œè¯·ä½¿ç”¨çŠ¶æ€å­—æ®µã€‚

å¦‚æœæ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•å®ç°æ‰©å±•ï¼Œé‚£ä¹ˆè§†å›¾æ’ä»¶é€šå¸¸ä¼šå¸¦æ¥æ›´å¥½çš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œå‡è®¾ä½ æƒ³å®ç°ä¸€ä¸ªç¼–è¾‘å™¨æ‰©å±•ï¼Œç”¨äºæ£€æŸ¥æ–‡æ¡£çš„æ‹¼å†™ã€‚

ä¸€ç§æ–¹æ³•æ˜¯å°†æ•´ä¸ªæ–‡æ¡£ä¼ é€’ç»™å¤–éƒ¨æ‹¼å†™æ£€æŸ¥å™¨ï¼Œç„¶åè¿”å›æ‹¼å†™é”™è¯¯åˆ—è¡¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦å°†æ¯ä¸ªé”™è¯¯æ˜ å°„åˆ°ä¸€ä¸ªè£…é¥°ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªçŠ¶æ€å­—æ®µæ¥ç®¡ç†è£…é¥°ï¼Œè€Œä¸ç®¡å½“å‰è§†çª—ä¸­æœ‰ä»€ä¹ˆã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯åªå¯¹è§†çª—ä¸­å¯è§çš„å†…å®¹è¿›è¡Œæ‹¼å†™æ£€æŸ¥ã€‚æ‰©å±•ç¨‹åºéœ€è¦åœ¨ç”¨æˆ·æ»šåŠ¨æ–‡æ¡£æ—¶æŒç»­è¿è¡Œæ‹¼å†™æ£€æŸ¥ï¼Œä½†ä½ å¯ä»¥å¯¹æ•°ç™¾ä¸‡è¡Œæ–‡æœ¬çš„æ–‡æ¡£è¿›è¡Œæ‹¼å†™æ£€æŸ¥ã€‚

![State field vs. view plugin](https://publish-01.obsidian.md/access/caa27d6312fe5c26ebc657cc609543be/Assets/decorations.svg)

## æä¾›è£…é¥°

æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨æƒ³åˆ›å»ºä¸€ä¸ªç¼–è¾‘å™¨æ‰©å±•ï¼Œç”¨è¡¨æƒ…ç¬¦å·æ›¿æ¢åˆ—è¡¨é¡¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è§†å›¾æ’ä»¶æˆ–çŠ¶æ€å­—æ®µæ¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œä½†ä¸¤è€…ä¹‹é—´å­˜åœ¨ä¸€äº›å·®å¼‚ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œä½ å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨è¿™ä¸¤ç§æ‰©å±•æ¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚

ä¸¤ç§å®ç°æ–¹å¼çš„æ ¸å¿ƒé€»è¾‘ç›¸åŒï¼š

1. ä½¿ç”¨ [syntaxTree](https://codemirror.net/docs/ref/#language.syntaxTree)Â  æŸ¥æ‰¾åˆ—è¡¨é¡¹ã€‚
2. å¯¹äºæ¯ä¸ªåˆ—è¡¨é¡¹ï¼Œç”¨ä¸€ä¸ªå°éƒ¨ä»¶æ›¿æ¢å‰å¯¼è¿å­—ç¬¦Â `-`Â ã€‚

### Widgets

Widgetæ˜¯å¯ä»¥æ·»åŠ åˆ°ç¼–è¾‘å™¨ä¸­çš„è‡ªå®šä¹‰ HTML å…ƒç´ ã€‚æ‚¨å¯ä»¥åœ¨æ–‡æ¡£çš„ç‰¹å®šä½ç½®æ’å…¥ Widgetï¼Œä¹Ÿå¯ä»¥ç”¨ Widget æ›¿æ¢æŸä¸ªå†…å®¹ã€‚

ä¸‹é¢çš„ç¤ºä¾‹å®šä¹‰äº†ä¸€ä¸ªè¿”å› HTML å…ƒç´ Â `<span>ğŸ‘‰</span>`Â çš„ widgetã€‚ç¨åæ‚¨å°†ä½¿ç”¨è¯¥ widgetã€‚

```ts
import { EditorView, WidgetType } from "@codemirror/view";

export class EmojiWidget extends WidgetType {
  toDOM(view: EditorView): HTMLElement {
    const div = document.createElement("span");

    div.innerText = "ğŸ‘‰";

    return div;
  }
}
```

è¦ä½¿ç”¨è¡¨æƒ…ç¬¦å·éƒ¨ä»¶æ›¿æ¢æ–‡æ¡£ä¸­çš„ä¸€ç³»åˆ—å†…å®¹ï¼Œè¯·ä½¿ç”¨Â [replace decoration](https://codemirror.net/docs/ref/#view.Decoration%5Ereplace) ã€‚

```ts
const decoration = Decoration.replace({
  widget: new EmojiWidget()
});
```

### çŠ¶æ€å­—æ®µ

ä»çŠ¶æ€æ ä¸­æä¾›è£…é¥°ï¼š

1. ä½¿ç”¨Â `DecorationSet`Â ç±»å‹å®šä¹‰[[çŠ¶æ€å­—æ®µ]]ã€‚
    
2. ä¸ºçŠ¶æ€å­—æ®µæ·»åŠ Â `provide`Â å±æ€§ã€‚
    
    ```ts
    provide(field: StateField<DecorationSet>): Extension {
      return EditorView.decorations.from(field);
    },
    ```
    

```ts
import { syntaxTree } from "@codemirror/language";
import {
  Extension,
  RangeSetBuilder,
  StateField,
  Transaction,
} from "@codemirror/state";
import {
  Decoration,
  DecorationSet,
  EditorView,
  WidgetType,
} from "@codemirror/view";
import { EmojiWidget } from "emoji";

export const emojiListField = StateField.define<DecorationSet>({
  create(state): DecorationSet {
    return Decoration.none;
  },
  update(oldState: DecorationSet, transaction: Transaction): DecorationSet {
    const builder = new RangeSetBuilder<Decoration>();

    syntaxTree(transaction.state).iterate({
      enter(node) {
        if (node.type.name.startsWith("list")) {
          // Position of the '-' or the '*'.
          const listCharFrom = node.from - 2;

          builder.add(
            listCharFrom,
            listCharFrom + 1,
            Decoration.replace({
              widget: new EmojiWidget(),
            })
          );
        }
      },
    });

    return builder.finish();
  },
  provide(field: StateField<DecorationSet>): Extension {
    return EditorView.decorations.from(field);
  },
});
```

### è§†å›¾æ’ä»¶

ä½¿ç”¨è§†å›¾æ’ä»¶ç®¡ç†è£…é¥°ï¼š

1. åˆ›å»ºè§†å›¾æ’ä»¶ã€‚
2. ä¸ºæ’ä»¶æ·»åŠ Â `DecorationSet`Â æˆå‘˜å±æ€§ã€‚
3. åˆå§‹åŒ–Â `constructor()`Â ä¸­çš„è£…é¥°ã€‚
4. åœ¨Â `update()`Â ä¸­é‡å»ºè£…é¥°ã€‚

å¹¶éæ‰€æœ‰æ›´æ–°éƒ½éœ€è¦é‡å»ºè£…é¥°ã€‚ä¸‹é¢çš„ç¤ºä¾‹åªåœ¨åº•å±‚æ–‡æ¡£æˆ–è§†çª—å‘ç”Ÿå˜åŒ–æ—¶é‡å»ºè£…é¥°ã€‚

```ts
import { syntaxTree } from "@codemirror/language";
import { RangeSetBuilder } from "@codemirror/state";
import {
  Decoration,
  DecorationSet,
  EditorView,
  PluginSpec,
  PluginValue,
  ViewPlugin,
  ViewUpdate,
  WidgetType,
} from "@codemirror/view";
import { EmojiWidget } from "emoji";

class EmojiListPlugin implements PluginValue {
  decorations: DecorationSet;

  constructor(view: EditorView) {
    this.decorations = this.buildDecorations(view);
  }

  update(update: ViewUpdate) {
    if (update.docChanged || update.viewportChanged) {
      this.decorations = this.buildDecorations(update.view);
    }
  }

  destroy() {}

  buildDecorations(view: EditorView): DecorationSet {
    const builder = new RangeSetBuilder<Decoration>();

    for (let { from, to } of view.visibleRanges) {
      syntaxTree(view.state).iterate({
        from,
        to,
        enter(node) {
          if (node.type.name.startsWith("list")) {
            // Position of the '-' or the '*'.
            const listCharFrom = node.from - 2;

            builder.add(
              listCharFrom,
              listCharFrom + 1,
              Decoration.replace({
                widget: new EmojiWidget(),
              })
            );
          }
        },
      });
    }

    return builder.finish();
  }
}

const pluginSpec: PluginSpec<EmojiListPlugin> = {
  decorations: (value: EmojiListPlugin) => value.decorations,
};

export const emojiListPlugin = ViewPlugin.fromClass(
  EmojiListPlugin,
  pluginSpec
);
```

`buildDecorations()`Â æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œå¯æ ¹æ®ç¼–è¾‘å™¨è§†å›¾åˆ›å»ºä¸€å¥—å®Œæ•´çš„è£…é¥°ã€‚

è¯·æ³¨æ„Â `ViewPlugin.fromClass()`Â å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚Â `PluginSpec`Â ä¸­çš„Â `decorations`Â å±æ€§æŒ‡å®šäº†è§†å›¾æ’ä»¶å‘ç¼–è¾‘å™¨æä¾›è£…é¥°çš„æ–¹å¼ã€‚

ç”±äºè§†å›¾æ’ä»¶çŸ¥é“ç”¨æˆ·å¯ä»¥çœ‹åˆ°ä»€ä¹ˆï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨Â `view.visibleRanges`Â æ¥é™åˆ¶è®¿é—®è¯­æ³•æ ‘çš„å“ªäº›éƒ¨åˆ†ã€‚

